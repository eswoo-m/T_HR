// 1. 클라이언트 및 ERD 생성기 설정
generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "./ERD.pdf"
}

// 2. DB 연결 설정
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 3. 모델 정의

model User {
  id       Int     @id @default(autoincrement())
  password String
  name     String
  email    String  @unique
  deptId   Int?
  position String?
  role     String?
}

model Organization {
  id        Int       @id @default(autoincrement())
  name      String
  parentId  Int?      @map("parent_id")
  startDate DateTime  @map("start_date") @db.Date
  endDate   DateTime? @default(dbgenerated("'9999-12-31'::date")) @map("end_date") @db.Date
  desc      String?
  regTime   DateTime  @default(now()) @map("reg_time")

  // ✅ 서비스 코드 호환용 별칭 (projects, employee)
  projects Project[]  @relation("OrganizationToProject")
  employee Employee[] @relation("EmployeeToOrganization")

  // 조직도 구조 (Self-relation)
  parent   Organization?  @relation("OrganizationToParent", fields: [parentId], references: [id])
  children Organization[] @relation("OrganizationToParent")

  // 기타 관계 및 히스토리
  employeesAsOrganization Employee[]                    @relation("EmployeeDepartment")
  employeesAsTeam         Employee[]                    @relation("EmployeeTeam")
  historiesAsOrganization EmployeeOrganizationHistory[] @relation("DepartmentRelation")
  historiesAsTeam         EmployeeOrganizationHistory[] @relation("TeamRelation")

  // DB Pull 시 생성되었던 기존 관계들 (에러 방지용)
  project_dept_rel Project[] @relation("project_department_idToorganization")

  @@index([parentId])
  @@index([startDate, endDate])
  @@index([name])
  @@map("organization")
}

model Employee {
  seq          Int       @default(autoincrement()) @map("seq")
  id           String    @unique @map("id")
  no           String    @unique @map("employee_no")
  nameKr       String    @map("name_kr")
  nameEn       String?   @map("name_en")
  nameCh       String?   @map("name_zh")
  residentNo   String    @unique @map("resident_no")
  password     String
  birthDate    DateTime  @map("birth_date") @db.Date
  isLunar      Boolean   @default(false) @map("is_lunar")
  gender       String    @default("UNKNOWN") @map("gender")
  departmentId Int?      @map("department_id")
  teamId       Int?      @map("team_id")
  deptId       Int?      @map("dept_id")
  jobLevel     String?   @map("job_level")
  jobRole      String?   @map("job_role")
  assignStatus String?   @map("assign_status")
  authLevel    String    @default("USER") @map("auth_level")
  email        String?
  joinDate     DateTime  @map("join_date") @db.Date
  exitDate     DateTime? @map("exit_date") @db.Date
  phone        String?

  // ✅ 관계 설정
  org        Organization? @relation("EmployeeToOrganization", fields: [deptId], references: [id])
  department Organization? @relation("EmployeeDepartment", fields: [departmentId], references: [id])
  team       Organization? @relation("EmployeeTeam", fields: [teamId], references: [id])

  assets                      Asset[]
  ownedFiles                  Attachment[]                  @relation("EmployeeFiles")
  uploadedFiles               Attachment[]                  @relation("UploadedFiles")
  certificates                Certificate[]
  employeeDetail              EmployeeDetail?
  employeeMonthlyMms          EmployeeMonthlyMm[]
  employeeOrganizationHistory EmployeeOrganizationHistory[]
  employeeTool                EmployeeTool?
  preProjectAssignments       PreProjectAssignment[]
  previousExperiences         PreviousExperience[]
  projectAssignments          ProjectAssignment[]
  technicalAbility            TechnicalAbility?

  @@index([id])
  @@index([no])
  @@index([departmentId, teamId])
  @@index([nameKr])
  @@index([assignStatus, authLevel])
  @@index([joinDate])
  @@map("employee")
}

model EmployeeDetail {
  id                Int         @id @default(autoincrement())
  employeeId        String      @unique @map("employee_id")
  type              String      @default("정규직") @map("type")
  hrStatus          String      @default("재직") @map("hr_status")
  skillLevel        String      @default("초급") @map("skill_level")
  leaveStartDate    DateTime?   @map("leave_start_date") @db.Date
  leaveEndDate      DateTime?   @map("leave_end_date") @db.Date
  eduLevel          String?     @map("edu_level")
  lastSchool        String?     @map("last_school")
  major             String?
  entranceDate      DateTime?   @map("entrance_date") @db.Date
  graduationDate    DateTime?   @map("graduation_date") @db.Date
  totalSwExperience Int?        @default(0) @map("total_sw_experience")
  prevSwExperience  Int?        @default(0) @map("prev_sw_experience")
  maritalStatus     String?     @map("marital_status")
  weddingAnniv      DateTime?   @map("wedding_anniv") @db.Date
  emergencyPhone    String?     @map("emergency_phone")
  emergencyRelation String?     @map("emergency_relation")
  zipCode           String?     @map("zip_code")
  address           String?
  addressDetail     String?     @map("address_detail")
  remarks           String?     @map("remarks") @db.Text
  profilePath       String?     @map("profile_path")
  commonCodeId      Int?
  CommonCode        CommonCode? @relation(fields: [commonCodeId], references: [id])
  employee          Employee    @relation(fields: [employeeId], references: [id])

  @@map("employee_detail")
}

model Project {
  id            Int       @id @default(autoincrement())
  name          String
  customerId    Int?      @map("customer_id")
  department_id Int?
  teamId        Int?      @map("team_id")
  regTime       DateTime  @default(now()) @map("reg_time")
  startDate     DateTime? @map("start_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date
  headcount     Int?      @default(0)
  amount        Decimal   @db.Decimal(15, 2)
  status        String?
  location      String?
  taskName      String?   @map("task_name")
  taskSummary   String?   @map("task_summary") @db.Text
  remarks       String?   @map("remarks") @db.Text

  // ✅ 서비스 코드 호환용 관계 설정
  customer Customer?     @relation(fields: [customerId], references: [id])
  team     Organization? @relation("OrganizationToProject", fields: [teamId], references: [id])
  dept_rel Organization? @relation("project_department_idToorganization", fields: [department_id], references: [id])

  projectAssignment ProjectAssignment[]
  projectContacts   ProjectContact[]

  @@unique([customerId, name])
  @@index([customerId])
  @@index([startDate, endDate])
  @@index([regTime])
  @@index([department_id])
  @@map("project")
}

model ProjectAssignment {
  id                      Int                       @id @default(autoincrement())
  projectId               Int                       @map("project_id")
  employeeId              String                    @map("employee_id")
  startDate               DateTime                  @map("start_date") @db.Date
  endDate                 DateTime?                 @map("end_date") @db.Date
  assignedRole            String?                   @map("assigned_role")
  tools                   String?
  workDetail              String?                   @map("work_detail") @db.Text
  contribution            String?                   @db.Text
  employee                Employee                  @relation(fields: [employeeId], references: [id])
  project                 Project                   @relation(fields: [projectId], references: [id])
  projectAssignmentPeriod ProjectAssignmentPeriod[]

  @@map("project_assignment")
}

model ProjectAssignmentPeriod {
  id           Int               @id @default(autoincrement())
  assignmentId Int               @map("assignment_id")
  status       String?
  startDate    DateTime          @map("start_date") @db.Date
  endDate      DateTime?         @map("end_date") @db.Date
  regTime      DateTime          @default(now()) @map("reg_time")
  assignment   ProjectAssignment @relation(fields: [assignmentId], references: [id])

  @@map("project_assignment_period")
}

model EmployeeMonthlyMm {
  id           Int      @id @default(autoincrement())
  employeeId   String   @map("employee_id")
  yearMonth    String   @map("year_month")
  startDate    DateTime @map("start_date") @db.Date
  endDate      DateTime @map("end_date") @db.Date
  assignStatus String?
  value        Decimal  @db.Decimal(5, 2)
  regTime      DateTime @default(now()) @map("reg_time")
  employee     Employee @relation(fields: [employeeId], references: [id])

  @@map("employee_monthly_mm")
}

model EmployeeOrganizationHistory {
  id           Int           @id @default(autoincrement())
  employeeId   String        @map("employee_id")
  departmentId Int           @map("department_id")
  teamId       Int?          @map("team_id")
  jobLevel     String?       @map("job_level")
  jobRole      String?       @map("job_role")
  applyDate    DateTime      @map("apply_date") @db.Date
  regTime      DateTime      @default(now()) @map("reg_time")
  department   Organization  @relation("DepartmentRelation", fields: [departmentId], references: [id])
  employee     Employee      @relation(fields: [employeeId], references: [id])
  team         Organization? @relation("TeamRelation", fields: [teamId], references: [id])

  @@map("employee_organization_history")
}

model PreviousExperience {
  id                Int       @id @default(autoincrement()) @map("id")
  employeeId        String    @map("employee_id")
  companyName       String    @map("company_name")
  department        String?   @map("department")
  jobLevel          String?   @map("jobLevel")
  jobRole           String?   @map("job_role")
  relevance         String    @default("유관") @map("relevance")
  entranceDate      DateTime  @map("entrance_date") @db.Date
  resignationDate   DateTime? @map("resignation_date") @db.Date
  assignedTask      String?   @map("assigned_task") @db.Text
  resignationReason String?   @map("resignation_reason")
  regTime           DateTime  @default(now()) @map("reg_time")
  employee          Employee  @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("previous_experience")
}

model Asset {
  id             Int        @id @default(autoincrement())
  employeeId     String?    @map("employee_id")
  name           String
  typeId         String?    @map("type_id")
  vendor         String?
  model          String?
  number         String?
  serialNo       String?    @map("serial_no")
  purchaseDate   DateTime?  @map("purchase_date") @db.Date
  purchaseAmount Decimal?   @map("purchase_amount") @db.Decimal(12, 2)
  warrantyDate   DateTime?  @map("warranty_date") @db.Date
  status         String?
  assignDate     DateTime?  @map("assign_date") @db.Date
  registDate     DateTime   @default(now()) @map("regist_date")
  assetTypeId    Int?
  assetType      AssetType? @relation(fields: [assetTypeId], references: [id])
  employee       Employee?  @relation(fields: [employeeId], references: [id])

  @@map("assets")
}

model AssetType {
  id       Int      @id @default(autoincrement())
  name     String
  isActive Boolean  @default(true) @map("is_active")
  regTime  DateTime @default(now()) @map("reg_time")
  assets   Asset[]

  @@map("assets_type")
}

model Customer {
  id         Int               @id @default(autoincrement())
  name       String
  businessNo String            @unique @map("business_no")
  ceoName    String?           @map("ceo_name")
  industry   String?
  tel        String?
  fax        String?
  address    String?
  homepage   String?
  status     String            @default("ACTIVE") @map("status")
  remarks    String?           @map("remarks") @db.Text
  regTime    DateTime          @default(now()) @map("reg_time")
  contacts   CustomerContact[]
  projects   Project[]

  @@map("customer")
}

model CustomerContact {
  id              Int              @id @default(autoincrement())
  name            String
  email           String?
  phone           String?
  tel             String?
  jobRole         String?
  department      String?
  remarks         String?          @map("remarks") @db.Text
  customerId      Int              @map("customer_id")
  isPrimary       Boolean          @default(false) @map("is_primary")
  regTime         DateTime         @default(now()) @map("reg_time")
  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  projectContacts ProjectContact[]

  @@map("customer_contact")
}

model ProjectContact {
  id        Int             @id @default(autoincrement())
  projectId Int             @map("project_id")
  contactId Int             @map("contact_id")
  regTime   DateTime        @default(now()) @map("reg_time")
  contact   CustomerContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  project   Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, contactId])
  @@map("project_contact")
}

model TechnicalAbility {
  employeeId         String   @id @map("employee_id")
  communicationSkill String?  @map("communication_skill") @db.Text
  officeSkill        String?  @map("office_skill") @db.Text
  testDesign         String?  @map("test_design") @db.Text
  testExecution      String?  @map("test_execution") @db.Text
  regTime            DateTime @default(now()) @map("reg_time")
  employee           Employee @relation(fields: [employeeId], references: [id])

  @@map("technical_ability")
}

model EmployeeTool {
  employeeId       String   @id @map("employee_id")
  defectSystem     String?  @map("defect_system") @db.Text
  messenger        String?  @map("messenger") @db.Text
  apiTool          String?  @map("api_tool") @db.Text
  etcTool          String?  @map("etc_tool") @db.Text
  updatregDateedAt DateTime @updatedAt @map("reg_date")
  employee         Employee @relation(fields: [employeeId], references: [id])

  @@map("employee_tool")
}

model PreProjectAssignment {
  id           Int       @id @default(autoincrement())
  employeeId   String    @map("employee_id")
  projectName  String    @map("project_name")
  customerName String?   @map("client_name")
  startDate    DateTime  @map("start_date") @db.Date
  endDate      DateTime? @map("end_date") @db.Date
  headcount    Int?      @default(0)
  taskName     String?   @map("task_name")
  taskSummary  String?   @map("task_summary") @db.Text
  assignedRole String?   @map("assigned_role")
  tools        String?
  workDetail   String?   @map("work_detail") @db.Text
  contribution String?   @db.Text
  regTime      DateTime  @default(now()) @map("reg_time")
  employee     Employee  @relation(fields: [employeeId], references: [id])

  @@map("pre_project_assignment")
}

model CommonCode {
  id             Int              @id @default(autoincrement()) @map("id")
  type           String           @map("type")
  code           String           @map("code")
  name           String           @map("name")
  isUsed         Boolean          @default(true) @map("is_used")
  regTime        DateTime         @default(now()) @map("reg_time")
  EmployeeDetail EmployeeDetail[]

  @@unique([type, code])
  @@map("common_code")
}

model Certificate {
  id               Int          @id @default(autoincrement()) @map("id")
  employeeId       String       @map("employee_id")
  type             String       @map("cert_type")
  name             String       @map("cert_name")
  issuingAuthority String       @map("issuing_authority")
  acquisitionDate  DateTime     @map("acquisition_date")
  expDate          DateTime?    @map("exp_date")
  regTime          DateTime     @default(now()) @map("reg_time")
  attachments      Attachment[]
  employee         Employee     @relation(fields: [employeeId], references: [id])

  @@map("certificate")
}

model Attachment {
  id            Int          @id @default(autoincrement()) @map("id")
  employeeId    String       @map("employee_id")
  refId         Int?         @map("ref_id")
  refType       String       @map("ref_type")
  fileType      String       @map("file_type")
  filePath      String       @map("file_path") @db.VarChar(500)
  fileName      String
  uploaderId    String       @map("uploader_id")
  certificateId Int?
  certificate   Certificate? @relation(fields: [certificateId], references: [id])
  employee      Employee     @relation("EmployeeFiles", fields: [employeeId], references: [id])
  uploader      Employee     @relation("UploadedFiles", fields: [uploaderId], references: [id])

  @@map("attachment")
}
